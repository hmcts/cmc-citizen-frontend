{% extends "layout.njk" %}
{% from "form.njk" import csrfProtection, linkButton, saveAndContinueButton, errorSummary %}

{% block additional_scripts %}
  <script src="{{ asset_paths['js'] }}/select-toggled-content.js"></script>
{% endblock %}

{% set title = t('Money claim') %}
{% set heading = t('List your evidence') %}

{% macro evidenceRow(index, form) %}

  {% set typeValue = form.valueFor('rows[' + index + '][type]').value %}
  {% set descriptionValue = form.valueFor('rows[' + index + '][description]') %}

  {% set errorType = form.errorFor('rows[' + index + '][type]').length > 0 %}
  {% set errorDescription = form.errorFor('rows[' + index + '][description]').length > 0 %}

  <div class="timeline-row {% if errorType %} form-group-error {% endif %}">
    <label class="visually-hidden" for="rows[{{ index }}][type]">{{ index + 1 }}{{ t('. Evidence') }}</label>
    {% if errorType %}
      <span class="error-message" id="{{ 'rows[' + index + '][type][label]' }}">
        {{ form.errorFor('rows[' + index + '][type]') }}
      </span>
    {% endif %}
    <select name="rows[{{ index }}][type]" id="rows[{{ index }}][type]"
      class="form-control-select {% if errorType %}form-control-error{% endif %}" >

      <option value="">{{ t('-- Please make a selection --') }}</option>
      {% for row in allEvidenceTypes %}
        <option value="{{ row.value }}" {% if typeValue == row.value %}selected{% endif %}>{{ row.displayValue }}</option>
      {% endfor %}
    </select>
    <div class="panel panel-border-narrow {% if not typeValue %} js-hidden {% endif %}">
      {% set name = 'rows[' + index + '][description]' %}
      {% set valueDescription = form.valueFor(name) %}
      {% set errorDescription = form.errorFor(name) %}
      <div class="form-group {% if errorDescription %} form-group-error {% endif %}">
        <label for="{{ name }}" id="{{ name }}[label]" class="form-label">
          {{ t('Describe this evidence in more detail (optional).') }}

          <span class="evidence-message evidence-message-CONTRACTS_AND_AGREEMENTS {% if typeValue !== EvidenceType.CONTRACTS_AND_AGREEMENTS.value %}visually-hidden{% endif %}">
            {{ t('For example, a signed contract by the claimant.') }}
          </span>
          <span class="evidence-message evidence-message-EXPERT_WITNESS {% if typeValue !== EvidenceType.EXPERT_WITNESS.value %}visually-hidden{% endif %}">
            {{ t('For example, a surveyor’s report.') }}
          </span>
          <span class="evidence-message evidence-message-CORRESPONDENCE {% if typeValue !== EvidenceType.CORRESPONDENCE.value %}visually-hidden{% endif %}">
            {{ t('For example, a letter from the claimant stating what work they expected you to do.') }}
          </span>
          <span class="evidence-message evidence-message-PHOTO {% if typeValue !== EvidenceType.PHOTO.value %}visually-hidden{% endif %}">
            {{ t('For example, a photo of the work you carried out.') }}
          </span>
          <span class="evidence-message evidence-message-RECEIPTS {% if typeValue !== EvidenceType.RECEIPTS.value %}visually-hidden{% endif %}">
            {{ t('For example, a receipt showing you’ve paid the claimant.') }}
          </span>
          <span class="evidence-message evidence-message-STATEMENT_OF_ACCOUNT {% if typeValue !== EvidenceType.STATEMENT_OF_ACCOUNT.value %}visually-hidden{% endif %}">
            {{ t('For example, a bank statement showing you’ve paid the claimant.') }}
          </span>
        </label>
        {% if errorDescription %}
          <span class="error-message">{{ t(error) }}</span>
        {% endif %}
        <textarea
          id="{{ name }}" name="{{ name }}"
          class="form-control timeline-column-text {% if errorDescription %}form-control-error{% endif %}"
          rows="2">{{ valueDescription | default('') }}</textarea>
      </div>
    </div>
  </div>
{% endmacro %}

{% block content %}
<div class="grid-row">
  <div class="column-two-thirds">

    <form method="post" novalidate>
      {{ csrfProtection(csrf) }}
      <h3 class="heading-small">{{ t('List your evidence (optional)') }}</h3>
      <p>
        {{
          t('You can submit evidence if your defence is rejected by the claimant - well let you know if that '
            + ' happens and what evidence you will need. You can, however, list any evidence you have at this stage.')
        }}
      </p>
      <div class="timeline">
        <div class="timeline-rows">
        {% for row in form.model.rows %}
          {{ evidenceRow(loop.index0, form) }}
        {% endfor %}
        </div>
        <br />
      </div>

      {% if canAddMoreEvidence %}
        <div id="add-event-container form-group">
          {{ linkButton('Add more evidence', 'action[addRow]', 'button button-secondary') }}
        </div>
      {% endif %}
      <br>

      <div class="panel panel-border-wide">
        <p>
            {{
              t('Your evidence list will only be sent to the claimant %s.',
                { postProcess: 'sprintf', sprintf: [ claimantName ] })
            }}
        </p>
      </div>

      {{ saveAndContinueButton() }}

    </form>
  </div>
</div>
{% endblock %}
