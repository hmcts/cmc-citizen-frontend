{% from "./caseStatus.njk" import caseStatusForClaimant, caseStatusForDefendant %}
{% from "timeRemaining.njk" import timeRemaining %}
{% from "form.njk" import submitButton %}

{#----------------------------------- Supporting Macros ----------------------------------------------#}

{% macro _claimRejectedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('The defendant’s response') }}</h2>
  <p>
    {{ t('{{ defendantName }} has rejected your claim. We’ll send you a directions questionnaire – '
    + 'this is a form which you must complete to tell us more about the claim.',
    { defendantName: claim.claimData.defendant.name }) }}
  </p>

  <p>
    {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download their Response') }}
  </p>
{% endmacro %}

{% macro downloadResponse(claim, url, text) %}
  <p>
    <a href="{{ ResponsePaths.receiptReceiver.evaluateUri({ externalId: claim.externalId }) }}">{{ t(text) }}</a>

  </p>
{% endmacro %}

{% macro downloadTheAgreement(claim, url) %}
  <p>
    <a
      href="{{ OfferPaths.agreementReceiver.evaluateUri({ externalId: claim.externalId }) }}">{{ t('Download the agreement') }}</a>
  </p>
{% endmacro %}

{% macro responseToOffer(claim, url) %}
  <p>
    <a href="{{ url }}">{{ t('View and respond to offer') }}</a>
  </p>
{% endmacro %}

{% macro emailLinkForFreeMediation(claim, url) %}
  <a
    href="mailto:moneyclaims@hmcts.gsi.gov.uk?Subject=Free%20Mediation%20Decision%20-%20Claim%20Number:%20{{ claim.claimNumber }}"
    target="_top">moneyclaims@hmcts.gsi.gov.uk</a>
{% endmacro %}

{#------------------------------------ Claimant Macros -----------------------------------------------#}

{% macro _noResponseForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('Your claim has been sent') }}</h2>
  <p>
    {{ t('{{ claimantName }} has until {{ responseDeadline }} to respond. They can request an extra 14 days if they need it.',
    { claimantName: claim.claimData.claimant.name,
      responseDeadline: claim.responseDeadline | date }) | safe }}
  </p>

{% endmacro %}

{% macro _CCJRequestedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('You’ve requested a County Court Judgment (CCJ).') }}</h2>
  <p>
    {{ t('We will contact you within 5 days to tell you whether the judgment has been entered.') }}
  </p>

  <p>
    {{ t('{{ defendantName }} can no longer respond to your claim using this service - '
    + 'they may have responded by post.',
    { defendantName: claim.claimData.defendant.name }) }}
  </p>

{% endmacro %}

{% macro _eligibileForCJJForClaimant(claim) %}
  <h2 class="bold-small">{{ t('You can request a County Court Judgment') }}</h2>
  <p>
    {{ t('{{ defendantName }} has not responded to your claim by the deadline. '
    + 'You can request a County Court Judgment (CCJ) against them.',
    { defendantName : claim.claimData.defendant.name }) }}
  </p>
  <p>
    {{ t('The court will make an order asking them to pay the money. It does not guarantee that they pay it.') }}
  </p>
  <p>
    {{ t('{{ defendantName }} can still respond to the claim until you request a CCJ.',
    { defendantName : claim.claimData.defendant.name }) }}
  </p>
  <form novalidate method="post">
    {{ submitButton('Request a County Court Judgment') }}
  </form>

{% endmacro %}

{% macro _moreTimeRequestedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('The defendant has requested more time to respond') }}</h2>
  <p>
    {{ t('{{ defendantName }} has requested an extra 14 days to respond. They need to respond by {{ responseDeadline }}.',
    { defendantName: claim.claimData.defendant.name ,
      responseDeadline: claim.responseDeadline | date }) | safe }}
  </p>

{% endmacro %}

{% macro _claimRejectedAlreadyPaidForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('The defendant’s response') }}</h2>
  <p>

    {{ t('{{ defendantName }} believes that they’ve paid the claim in full. '
    + 'Email moneyclaims@hmcts.gsi.gov.uk if you want to proceed with the claim - '
    + 'you must do this before {{ respondToResponseDeadline }}.',
    {
      defendantName: defendantName,
      respondToResponseDeadline: claim.respondToResponseDeadline | date
    }) }}
  </p>
  <p>
    {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download their Response') }}
  </p>
{% endmacro %}

{% macro _claimRejectedFreeMediationNOForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('The defendant’s response') }}</h2>
  <p>
    {{ t('{{ defendantName }} has rejected your claim. We’ll send you a directions questionnaire – '
    + 'this is a form which you must complete to tell us more about the claim.',
    { defendantName: claim.claimData.defendant.name }) }}
  </p>

  <p>
    {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download their Response') }}
  </p>

{% endmacro %}

{% macro _claimRejectedFreeMediationYESForClaimant(claim) %}
  <p>
  <h2 class="heading-medium">{{ t('The defendant’s response') }}</h2>
  {{ t('{{ defendantName }} has rejected the claim. They’ve suggested mediation to help resolve this dispute.',
  { defendantName: claim.claimData.defendant.name }) }}
  </p>
  <p>
    {{ t('Tell us whether you agree to mediation or not by emailing ') }}
    {{ emailLinkForFreeMediation(claim, url) }}
    {{ t(' before {{ offerResponseDeadline? }}XXXXX',
    {offerResponseDeadline: offerResponseDeadline }) }}
  </p>
  {#Todo Ask Marc if we have a free mediation deadline#}
  {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download their Response') }}

  {#TODO Do they want a link for email?#}

{% endmacro %}

{% macro _offerSubmittedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('{{ defendantName }} has made an offer to settle out of court. '
    + 'You must accept or reject by 4pm on XXXXX{{ offerDeadline??? }}.',
    { defendantName: claim.claimData.defendant.name }) }}
  </p>
  {#todo Clarify with Marc as we dont currently have an offer deadline#}

  {{ responseToOffer(claim, DashboardUrlHelper.getStatusUrl(claim)) }}
{% endmacro %}

{% macro _offerAcceptedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('You’ve agreed to the offer made by {{ defendantName }} and signed an agreement to settle your claim.',
    { defendantName: claim.claimData.defendant.name }) }}
  </p>

{% endmacro %}

{% macro _offerRejectedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('You’ve rejected the defendant’s offer to settle out of court. '
    + 'You won’t receive any more offers from the defendant.') }}
  </p>
{% endmacro %}

{% macro _offerSettlementReachedForClaimant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('You’ve both signed a legal agreement. The claim is now settled.') }}
  </p>

  {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download their Response') }}
{% endmacro %}

{#----------------------------------- Defendant Macros ----------------------------------------------#}

{% macro _noResponseForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('You haven’t responded to this claim') }}</h2>
  <p>
    {{ t('You need to respond before 4pm on {{ responseDeadline }}.',
    { responseDeadline: claim.responseDeadline | date }) }}
  </p>

  <a href="{{ url }}">{{ t('Respond to claim') }}</a>
{% endmacro %}

{% macro _CCJRequesterForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('The claimant has requested a CCJ against you') }}</h2>
  <p>
    {{ t('You didn’t respond to this claim by the deadline of {{ responseDeadline }}.',
    { responseDeadline: claim.responseDeadline | date }) }}
  </p>
  <p>
    {{ t('{{ claimantName }} requested a default County Court Judgment (CCJ) against you on {{ ccjRequestedAt }}. '
    + 'We’ll contact you within 5 days to tell you whether the claimant’s request for judgment has been successful.',
    { claimantName : claim.claimData.claimant.name, ccjRequestedAt: claim.countyCourtJudgmentRequestedAt | date }) }}
  </p>

  <p>{{ t('You can no longer respond to the claim.') }}</p>

  <p>
    <a target="blank"
       href="https://www.gov.uk/county-court-judgments-ccj-for-debt">{{ t('Find out more about County Court Judgments') }}</a>
  </p>
  {#todo No link URL was provided. I got this from .gov#}

{% endmacro %}

{% macro _claimRejectedAlreadyPaidForDefendant(claim) %}
  <p>
    {{ t('We’ve emailed {{ claimantName }} telling them when and how you said you paid the claim.',
    { claimantName: claimantName }) }}
  </p>
  <p>
    {{ t('We’ll contact you to let you know how they respond. They can confirm you’ve paid and the claim is ' +
    'settled, or they can proceed with it.') }}
  </p>
{% endmacro %}

{% macro _claimRejectedFreeMediationNOForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('Your response to the claim') }}</h2>

  <p>
    {{ t('You have rejected the claim. We’ll send you a directions questionnaire – this is a form which you must '
    + 'complete to tell us more about the claim.') }}
  </p>

  <p>
    {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download your Response') }}
  </p>
{% endmacro %}

{% macro _claimRejectedFreeMediationYESForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('Your response to the claim') }}</h2>
  <p>
    {{ t('You have rejected the claim. You’ve suggested mediation.') }}
  </p>

  <p>
    {{ t('We’ll ask {{ claimantName }} if they agree to take part in mediation.',
    {claimantName: claim.claimData.claimant.name}) }}
  </p>

  <p>
    {{ t('If they say yes, we’ll arrange a date for mediation. '
    + 'If they say no we’ll send you a directions questionnaire - '
    + 'this is a form you complete to tell us more about the claim.') }}
  </p>

  <p>
    {{ downloadResponse(claim, DashboardUrlHelper.getStatusUrl(claim), 'Download your Response') }}
  </p>
{% endmacro %}

{% macro _offerSubmittedForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('You made an offer to settle the claim out of court. {{ claimantName }} can accept or reject your offer.',
    {claimantName: claim.claimData.claimant.name}) }}
  </p>

  <p>{{ t('We’ll email you when they respond.') }}</p>

{% endmacro %}

{% macro _offerAcceptedForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('The claimant has accepted your offer and signed a legal agreement. '
    + 'You need to sign the agreement to settle out of court.') }}
  </p>
  <p>
    {{ t('When you’ve both signed the agreement, the claim won’t proceed.') }}
  </p>
  <p>
    <a
      href="{{ OfferPaths.countersignAgreementPage.evaluateUri({ externalId: claim.externalId }) }}">{{ t('Sign the agreement') }}</a>
  </p>
{% endmacro %}

{% macro _offerRejectedForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('Settle out of court') }}</h2>
  <p>
    {{ t('The claimant has rejected your offer to settle the claim. Complete the directions questionnaire.') }}
  </p>

{% endmacro %}

{% macro _offerSettlementReachedForDefendant(claim) %}
  <h2 class="heading-medium">{{ t('Agreement signed') }}</h2>
  <p>
    {{ t('You’ve both signed a legal agreement. The claim is now settled.') }}
  </p>

  <p>
    {{ downloadTheAgreement(claim, DashboardUrlHelper.getStatusUrl(claim)) }}
  </p>
{% endmacro %}

{#----------------------------------- CASE HISTORY MACROS-----------------------------------------------#}
{% macro caseHistoryForClaimant(claim, url) %}
  {% set defendantName = claim.claimData.defendant.name %}
  {% for state in claim.stateHistory %}
    <div class="status-block">

      {% if state.status === ClaimStatus.NO_RESPONSE %}
        {{ _noResponseForClaimant(claim) }}

        {% elif state.status === ClaimStatus.MORE_TIME_REQUESTED %}
        {{ _moreTimeRequestedForClaimant(claim) }}

        {% elif state.status === ClaimStatus.ELIGIBLE_FOR_CCJ %}
        {{ _eligibileForCJJForClaimant(claim) }}

        {% elif state.status === ClaimStatus.CCJ_REQUESTED %}
        {{ _CCJRequestedForClaimant(claim) }}

        {% elif state.status === ClaimStatus.CLAIM_REJECTED %}
        {% if claim.response.defenceType === DefenceType.ALREADY_PAID %}
          {{ _claimRejectedAlreadyPaidForClaimant }}

          {% elif claim.response.freeMediation === FreeMediationOption.NO %}
          {{ _claimRejectedFreeMediationNOForClaimant(claim) }}

        {% else %}
          {{ _claimRejectedFreeMediationYESForClaimant(claim) }}
        {% endif %}

        {% elif state.status === ClaimStatus.OFFER_SUBMITTED %}
        {{ _offerSubmittedForClaimant(claim) }}

        {% elif state.status === ClaimStatus.OFFER_REJECTED %}
        {{ _offerRejectedForClaimant(claim) }}

        {% elif state.status === ClaimStatus.OFFER_ACCEPTED %}
        {{ _offerAcceptedForClaimant(claim) }}

        {% elif state.status === ClaimStatus.OFFER_SETTLEMENT_REACHED %}
        {{ _offerSettlementReachedForClaimant(claim) }}

      {% else %}
        <p>
          {{ caseStatusForClaimant(state.status, claim, url) }}
        </p>
      {% endif %}
    </div>
  {% endfor %}
{% endmacro %}

{% macro caseHistoryForDefendant(claim, url, isAfter4pm) %}
  {% set claimantName = claim.claimData.claimant.name %}
  {% for state in claim.stateHistory %}
    <div class="status-block">

      {% if state.status === ClaimStatus.CCJ_REQUESTED %}
        {{ _CCJRequesterForDefendant(claim) }}

        {% elif state.status === ClaimStatus.CLAIM_REJECTED %}
          {% if claim.response.defenceType === DefenceType.ALREADY_PAID %}
            {{ _claimRejectedAlreadyPaidForDefendant(claim) }}
          {% endif %}
          {% if claim.response.freeMediation === FreeMediationOption.NO %}
            {{ _claimRejectedFreeMediationNOForDefendant(claim) }}
            {% else %}
            {{ _claimRejectedFreeMediationYESForDefendant(claim) }}
          {% endif %}

        {% elif state.status === ClaimStatus.OFFER_SUBMITTED %}
        {{ _offerSubmittedForDefendant(claim) }}

        {% elif state.status === ClaimStatus.OFFER_REJECTED %}
        {{ _offerRejectedForDefendant(claim) }}

        {% elif state.status === ClaimStatus.OFFER_ACCEPTED %}
        {{ _offerAcceptedForDefendant(claim) }}

        {% elif state.status === ClaimStatus.OFFER_SETTLEMENT_REACHED %}
        {{ _offerSettlementReachedForDefendant(claim) }}

        {% elif state.status === ClaimStatus.NO_RESPONSE %}
        {{ _noResponseForDefendant() }}
      {% else %}
        <p>
          {{ caseStatusForDefendant(claim.status, claim, DashboardUrlHelper.getStatusUrl(claim), isAfter4pm) }}
        </p>
      {% endif %}
    </div>
  {% endfor %}
{% endmacro %}
